DCX.addModule("ajaxListener",function(d){var n={},j=false,l,s,D,m,x=d.utils;function t(G){var I,E,J,H=false,F=n.urlBlocklist;if(!G||!F){return H}for(I=0,E=F.length;!H&&I<E;I+=1){J=F[I];H=J.cRegex.test(G)}return H}function g(G,L,F){var I,E,J={},K=n.filters,H;if(!K||!K.length){return J}for(I=0,E=K.length,H=false;!H&&I<E;I+=1){J=K[I];H=true;if(J.url){H=J.url.cRegex.test(G)}if(H&&J.method){H=J.method.cRegex.test(L)}if(H&&J.status){H=J.status.cRegex.test(F)}}if(!H){J=null}return J}function q(I){var K={},G,E,J,F,H;I=I.split(/[\r\n]+/);for(G=0,E=I.length;G<E;G+=1){J=I[G].split(": ");F=J[0];H=x.rtrim(J[1]);if(F&&F.length){K[F]=H}}return K}function r(H,I,F){if(typeof H==="object"&&H!==null){for(var E in H){if(E===I||(I instanceof RegExp&&I.test(E))){H[E]=F}else{if(typeof H[E]==="object"){r(H[E],I,F)}}}}else{if(typeof H==="string"){const G=new RegExp(I,"gi");H=H.replace(G,F).trim()}}return H}function a(H,E){if(typeof H!=="object"){return H}var G=JSON.stringify(H);try{E.forEach(function(I){H=r(H,I.field,I.replacement)});return H}catch(F){console.error("wrong Sensitive Info passed",F);return JSON.parse(G)}}function i(H,G){if(typeof H==="object"){var F=JSON.stringify(H);try{H=F;G.forEach(function(I){var K=I.pattern,J=new RegExp(K.regex,K.flags);if(J.test(H)){H=H.replace(J,I.replacement)}});return JSON.parse(H)}catch(E){console.error("wrong Privacy Pattern passed",E);return JSON.parse(F)}}else{G.forEach(function(I){var K=I.pattern,J=new RegExp(K.regex,K.flags);if(J.test(H)){H=H.replace(J,I.replacement)}});return H}}function o(M,I){var F={type:3,connectionEvent:{name:"ajaxListener",data:{interfaceType:"XHR"}}},H,G=F.connectionEvent.data,E;if(!M){return}H=document.createElement("a");H.href=M.tListener.url;G.originalURL=H.host+(H.pathname[0]==="/"?"":"/")+H.pathname;G.requestURL=d.normalizeUrl?d.normalizeUrl(G.originalURL,3):G.originalURL;G.description="Full Ajax Monitor "+G.requestURL;G.method=M.tListener.method;G.status=M.status;G.statusText=M.statusText||"";G.async=M.tListener.async;G.ajaxResponseTime=M.tListener.end-M.tListener.start;G.locationHref=d.normalizeUrl(document.location.href,3);if(I.queryString&&window.location.search){G.queryString=x.getQueryString(window.location.search)}if(I.requestHeaders){G.requestHeaders=M.tListener.reqHeaders}if(I.requestData&&typeof M.tListener.reqData==="string"&&!M.tListener.isSystemXHR){try{G.request=JSON.parse(M.tListener.reqData)}catch(L){G.request=M.tListener.reqData}if(I.privacyPatterns.length>0&&Object.keys(G.request).length){try{G.request=i(G.request,I.privacyPatterns)}catch(J){}}if(I.sensitiveFields.length>0&&Object.keys(G.request).length){try{G.request=a(G.request,I.sensitiveFields)}catch(J){}}}if(I.responseHeaders){G.responseHeaders=q(M.getAllResponseHeaders())}if(I.responseData){if(typeof M.responseType==="undefined"){E=M.responseText}else{if(M.responseType===""||M.responseType==="text"){E=M.response}else{if(M.responseType==="json"){G.response=M.response}else{G.response=typeof M.response}}}if(E){try{G.response=JSON.parse(E)}catch(K){G.response=E}if(I.privacyPatterns.length>0&&Object.keys(G.response).length){try{G.response=i(G.response,I.privacyPatterns)}catch(J){}}if(I.sensitiveFields.length>0&&Object.keys(G.response).length){try{G.response=a(G.response,I.sensitiveFields)}catch(J){}}}if(M.responseType){G.responseType=M.responseType}}d.post(F)}function u(G){var I,H={},F=G.entries(),E=F.next();while(!E.done){I=E.value;H[I[0]]=I[1];E=F.next()}return H}function h(E){return u(E)}function c(E){var G=E;if(!E){return G}if(typeof E==="object"&&E.toString().indexOf("FormData")!==-1){G=u(E)}else{if(typeof E==="string"){try{G=JSON.parse(E)}catch(F){G=E}}}return G}function v(E,H,I){var K={type:3,connectionEvent:{name:"ajaxListener",data:{interfaceType:"fetch"}}},G,F=K.connectionEvent.data,L;G=document.createElement("a");G.href=E.url;F.originalURL=G.host+(G.pathname[0]==="/"?"":"/")+G.pathname;F.requestURL=d.normalizeUrl?d.normalizeUrl(F.originalURL,3):F.originalURL;F.description="Full Ajax Monitor "+F.requestURL;F.method=E.initData.method;F.status=H.status;F.statusText=H.statusText||"";F.async=true;F.ajaxResponseTime=E.end-E.start;F.responseType=H.type;F.locationHref=d.normalizeUrl(document.location.href,3);if(I.queryString&&window.location.search){F.queryString=x.getQueryString(window.location.search)}if(I.requestHeaders){if(E.initData.headers&&E.initData.headers.toString().indexOf("Headers")!==-1){F.requestHeaders=h(E.initData.headers)}else{F.requestHeaders=E.initData.headers||""}}if(I.requestData&&typeof E.body!=="undefined"&&!E.isSystemXHR){F.request=c(E.body);if(I.privacyPatterns.length>0&&Object.keys(F.request).length){try{F.request=i(F.request,I.privacyPatterns)}catch(J){}}if(I.sensitiveFields.length>0&&Object.keys(F.request).length){try{F.request=a(F.request,I.sensitiveFields)}catch(J){}}}if(I.responseHeaders){F.responseHeaders=h(H.headers)}if(I.responseData){L=H.headers.get("content-type");if(L&&L.indexOf("application/json")!==-1){H.clone().json().then(function(M){F.response=M;if(I.privacyPatterns.length>0&&Object.keys(F.response).length){try{F.response=i(F.response,I.privacyPatterns)}catch(N){}}if(I.sensitiveFields.length>0&&Object.keys(F.response).length){try{F.response=a(F.response,I.sensitiveFields)}catch(N){}}d.post(K)});return}if(L&&(L.indexOf("text")!==-1||L.indexOf("xml")!==-1)){H.clone().text().then(function(M){F.response=M;if(I.privacyPatterns.length>0&&Object.keys(F.response).length){try{F.response=i(F.response,I.privacyPatterns)}catch(N){}}if(I.sensitiveFields.length>0&&Object.keys(F.response).length){try{F.response=a(F.response,I.sensitiveFields)}catch(N){}}d.post(K)});return}F.response="Not logging unsupported response content: "+L}d.post(K)}function p(I){var G,F=I.tListener.url,J=I.tListener.method,E=I.status.toString(),H={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};G=g(F,J,E);if(G){if(G.log){H=G.log}o(I,H)}}function b(E,I){var H,G=E.url,K=E.initData.method,F=I.status.toString(),J={requestHeaders:false,requestData:false,responseHeaders:false,responseData:false};if(t(G)){return}H=g(G,K,F);if(H){if(H.log){J=H.log}v(E,I,J)}}function A(F){var G,E;if(!F||!F.target){return}G=F.target;E=G.readyState;if(E===4){G.removeEventListener("readystatechange",A);G.tListener.end=Date.now();p(G)}}function w(F){var E=F.setRequestHeader;F.setRequestHeader=function(J,H){var I=this,G=I.tListener;if(J&&J.length){G.reqHeaders[J]=H}return E.apply(I,arguments)}}function C(E){var F=E.send;E.send=function(H){var I=this,G=I.tListener;if(H){G.reqData=H}G.start=Date.now();return F.apply(I,arguments)}}function y(F){var G,E,H;E=DCX.getServiceConfig("queue");H=E.queues||[];for(G=0;G<H.length;G+=1){if(H[G].endpoint&&F.indexOf(H[G].endpoint)!==-1){return true}}return false}function z(H,E,F){var G=this;if(j){G.addEventListener("readystatechange",A);G.tListener={method:H,url:E,async:(typeof F==="undefined")?true:!!F,reqHeaders:{},isSystemXHR:y(E)};w(G);C(G)}return l.apply(G,arguments)}function B(){if(XMLHttpRequest){l=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=z}}function k(){s=window.fetch;window.fetch=function(G,F){var E={},H;if(typeof G==="object"){E.initData=G;E.url=G.url;E.initData.clone().text().then(function(I){if(I.length>0){E.body=I}})}else{E.initData=F||{};E.url=G;if(F&&F.body){E.body=F.body}}E.isSystemXHR=y(E.url);E.start=Date.now();H=s.apply(this,arguments);return H.then(function(I){E.end=Date.now();b(E,I);return I})}}function e(E){if(E&&E.regex){E.cRegex=new RegExp(E.regex,E.flags)}}function f(G){var H,E,I,J=[],F=x.getValue(G,"skipSafetyCheck",false);if(G&&G.filters){J=G.filters}for(H=0,E=J.length;H<E;H+=1){I=J[H];x.forEach([I.url,I.method,I.status],e)}if(G&&G.urlBlocklist){x.forEach(G.urlBlocklist,e)}D=x.getValue(G,"xhrEnabled",true)&&window.XMLHttpRequest;if(D&&!F&&(XMLHttpRequest.toString().indexOf("[native code]")===-1||XMLHttpRequest.toString().indexOf("XMLHttpRequest")===-1)){D=false}m=x.getValue(G,"fetchEnabled",true)&&window.fetch;if(m&&!F&&window.fetch.toString().indexOf("[native code]")===-1){m=false}}return{init:function(){n=d.getConfig();f(n)},destroy:function(){j=false},onevent:function(E){switch(E.type){case"load":if(D){B()}if(m){k()}j=true;break;case"unload":j=false;break;default:break}},version:"1.2.0"}});